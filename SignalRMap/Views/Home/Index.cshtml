@{
    ViewBag.Title = "SignalR Map";
}

<script charset="UTF-8" type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
<script src="@Url.Content("~/Scripts/jquery-1.6.4.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.signalR.min.js")" type="text/javascript"></script>
<script type="text/javascript" src="@Url.Content("~/signalr/hubs")"></script>

<div id='mapDiv'></div>


<script type="text/javascript">

	var map = null;
	var pushPins = [];

	$(function () {


		var chat = $.connection.mapHub;


		chat.addClient = function (client) {
			var pins = getPushPins();
			
			// ignore this if it's the first call
			if (pins.length > 0)
				addClient(client);

			centerMap();
		};


		chat.addClients = function (clients) {
			console.log('addClients: ' + clients.length);
			for (var i = 0; i < clients.length; i++)
				addClient(clients[i].Value);

			centerMap();
		} // end chat.addClients function


		chat.removeClient = function (client) {
			console.log('remove: ' + client);
			for (var i = map.entities.getLength() - 1; i >= 0; i--) {
				var pushpin = map.entities.get(i);
				if (pushpin instanceof Microsoft.Maps.Pushpin) {
					if (pushpin.getLocation().latitude == client.latitude && pushpin.getLocation().longitude == client.longitude) {
						map.entities.removeAt(i);
					} // end if
				} // end if
			} // end for
		} // end chat.removeClient

		$.connection.hub.start(function () {
			navigator.geolocation.getCurrentPosition(function (position) {
				mappit(position);
				var rndPosition = createRandomPosition(position);
				var message = { 'user': 'user 1', 'location': { latitude: rndPosition.latitude, longitude: rndPosition.longitude} };
				chat.join(message);
			});
		});


	});

	/**
	 * addClient
	 **/
	function addClient(client) {
		
		var location = new Microsoft.Maps.Location(client.location.latitude, client.location.longitude);
		var pushpin = new Microsoft.Maps.Pushpin(location, { text: client.clientId });
		map.entities.push(pushpin);

		map.setView({
			center: new Microsoft.Maps.Location(client.location.latitude, client.location.longitude),
			zoom: 1
		});
	} // end addClient function

	

	/**
	 * mappit
	 **/
	function mappit(position) {
		
		var mapOptions = {
			credentials: "AnONREX2RmJq2kD0D_M7CWB1zPPkNBRj2ocFkXq1HCEIU7nku7zKiTwCfzMtQOnb",
			center: new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude)//,
			//zoom: 14
		}
		map = new Microsoft.Maps.Map(document.getElementById("mapDiv"), mapOptions);				
	} // end mappit function


	/**
	 * createRandomPosition
	 **/
	function createRandomPosition(position) {
		var latitude = position.coords.latitude + ((Math.random() * 5)) - 2.5;
		var longitude = position.coords.longitude + ((Math.random() * 5)) - 2.5;
		return { latitude: latitude, longitude: longitude };
	} // end createRandomPosition function

	/**
	 * centerMap
	 **/
	function centerMap() {

		var pins = getPushPins();

		var locations = [];		
		for (var i = pins.length-1; i>=0; i--) 
			locations.push(pins[i].getLocation());

		if (locations.length == 1) {
			map.setView({
				zoom: 15
			});
		} else {
			map.setView({
				bounds: Microsoft.Maps.LocationRect.fromLocations(locations)
			});
		} // end else
	} // end centerMap function

	/**
	 * getPushPins
	 **/
	function getPushPins() {
		var pins = [];
		for (var i = map.entities.getLength() - 1; i >= 0; i--) {
			var pushpin = map.entities.get(i);
			if (pushpin instanceof Microsoft.Maps.Pushpin) {
				pins.push(pushpin);		
			} // end if
		} // end for
		return pins;
	} // end getPushPins function
	
	
</script>

